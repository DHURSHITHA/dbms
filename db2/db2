CREATE DATABASE DB2;
USE DB2;

CREATE TABLE Users (
    user_id INT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    user_type ENUM('buyer', 'seller') NOT NULL
); 

CREATE TABLE Products (
    product_id INT PRIMARY KEY,
    seller_id INT,
    name VARCHAR(100) NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    stock INT NOT NULL,
    FOREIGN KEY (seller_id) REFERENCES Users(user_id)
); 

CREATE TABLE Orders (
    order_id INT PRIMARY KEY,
    buyer_id INT,
    order_date DATE,
    FOREIGN KEY (buyer_id) REFERENCES Users(user_id)
); 

CREATE TABLE OrderItems (
    order_item_id INT PRIMARY KEY,
    order_id INT,
    product_id INT,
    quantity INT NOT NULL,
    FOREIGN KEY (order_id) REFERENCES Orders(order_id),
    FOREIGN KEY (product_id) REFERENCES Products(product_id)
); 

-- Insert Users and Products
INSERT INTO Users (user_id, name, email, user_type) VALUES
(1, 'Alice', 'alice@example.com', 'buyer'),
(2, 'Bob', 'bob@example.com', 'seller');

INSERT INTO Products (product_id, seller_id, name, price, stock) VALUES
(1, 2, 'Laptop', 75000.00, 10),
(2, 2, 'Phone', 30000.00, 20);

-- Create Trigger BEFORE inserting into Orders and OrderItems
DELIMITER //
CREATE TRIGGER reduce_stock AFTER INSERT ON OrderItems
FOR EACH ROW
BEGIN
    UPDATE Products
    SET stock = stock - NEW.quantity
    WHERE product_id = NEW.product_id;
END;
//
DELIMITER ;

-- Now Insert Orders and OrderItems
INSERT INTO Orders (order_id, buyer_id, order_date) VALUES
(1, 1, CURDATE());

INSERT INTO OrderItems (order_item_id, order_id, product_id, quantity) VALUES
(1, 1, 1, 2),  -- Buying 2 Laptops
(2, 1, 2, 1);  -- Buying 1 Phone

-- Check final product stock
SELECT * FROM Products;

